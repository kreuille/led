<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WLED Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { 
            background-color: #0f172a; 
            color: #f8fafc; 
            font-family: 'Segoe UI', system-ui, sans-serif;
            overscroll-behavior: none;
            user-select: none;
            padding-bottom: 80px; /* Espace pour le bouton master */
        }

        /* --- STYLES GRILLE ZONES --- */
        .zone-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 3px;
            margin-bottom: 10px;
        }
        .zone-block {
            aspect-ratio: 1;
            background-color: #334155;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }
        .zone-block.active {
            background-color: #3b82f6;
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
        }
        .zone-label {
            position: absolute; bottom: 1px; right: 1px;
            font-size: 6px; color: rgba(255,255,255,0.3);
        }

        /* --- STYLES UI --- */
        .glass-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        .glass-card.inactive-mode { opacity: 0.4; filter: grayscale(1); }
        .glass-card.active-mode { 
            border-color: rgba(59, 130, 246, 0.5); 
            background: rgba(30, 41, 59, 0.9);
        }

        /* Sliders & Toggles */
        input[type=range].cct-slider {
            -webkit-appearance: none; width: 100%; height: 24px; border-radius: 12px;
            background: linear-gradient(to right, #ff8c00 0%, #ffebcd 45%, #ffffff 50%, #e0ffff 55%, #a0c4ff 100%);
            outline: none; margin-top: 5px;
        }
        input[type=range].cct-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 30px; height: 30px; border-radius: 50%;
            background: #fff; border: 3px solid #1e293b; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        
        .toggle-checkbox:checked { right: 0; border-color: #3b82f6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }
        
        .iro-container { display: flex; justify-content: center; margin-top: 5px; }
    </style>
</head>
<body class="min-h-screen p-3 flex flex-col items-center gap-4">

    <!-- HEADER -->
    <div class="w-full max-w-md space-y-3">
        <div class="flex justify-between items-center">
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-300">
                WLED Commander
            </h1>
            <input type="text" id="wled-ip" class="bg-gray-800/50 rounded px-2 py-1 text-xs text-gray-400 w-24 text-center focus:outline-none" placeholder="IP Address">
        </div>

        <!-- OPTIONS BAR -->
        <div class="flex items-center justify-between bg-gray-800/50 rounded-xl p-2 px-3 border border-white/5">
            <span class="text-xs text-gray-300 flex items-center gap-2">
                <i class="fa-solid fa-link"></i> Mode Combiné
            </span>
            <div class="relative inline-block w-8 align-middle select-none">
                <input type="checkbox" id="fusion-toggle" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 ease-in-out left-0 top-0"/>
                <label for="fusion-toggle" class="toggle-label block overflow-hidden h-4 rounded-full bg-gray-700 cursor-pointer"></label>
            </div>
        </div>
    </div>

    <!-- 1. ZONE SELECTOR (Repliable) -->
    <div class="glass-card w-full max-w-md p-4">
        <div class="flex justify-between items-center mb-2 cursor-pointer" onclick="toggleZonePanel()">
            <h2 class="text-xs font-bold uppercase text-gray-400 tracking-wider"><i class="fa-solid fa-ruler-horizontal mr-1"></i>Découpage des Zones</h2>
            <i class="fa-solid fa-chevron-down text-gray-500 text-xs transition-transform" id="zone-chevron"></i>
        </div>
        
        <div id="zone-content" class="hidden"> <!-- Caché par défaut pour gagner de la place -->
            <div class="flex justify-end gap-2 mb-2 text-[10px]">
                <button onclick="zonesSelectAll(true)" class="text-blue-400">Tout</button>
                <button onclick="zonesSelectAll(false)" class="text-gray-400">Rien</button>
            </div>
            
            <div id="zone-grid" class="zone-grid"></div>

            <button onclick="applyZones()" class="w-full bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold py-2 rounded shadow-lg transition-colors">
                APPLIQUER LA CONFIGURATION
            </button>
            <p class="text-[9px] text-gray-500 text-center mt-2">Crée les segments RGB/Blanc entrelacés automatiquement.</p>
        </div>
    </div>

    <!-- 2. CONTROLS CONTAINER -->
    <!-- CCT CARD -->
    <div id="card-white" class="glass-card w-full max-w-md p-4" onclick="activateType('white')">
        <div class="flex items-center gap-3 mb-3">
            <div class="w-8 h-8 rounded-full bg-orange-500/20 flex items-center justify-center text-orange-200"><i class="fa-regular fa-sun"></i></div>
            <div class="flex-1">
                <h3 class="font-bold text-gray-200 text-sm">Canal Blanc</h3>
                <div class="h-1 w-full bg-gray-700 rounded-full mt-1 overflow-hidden">
                    <div id="bar-white" class="h-full bg-orange-400 w-0 transition-all duration-500"></div>
                </div>
            </div>
        </div>
        
        <input type="range" min="0" max="100" value="50" class="cct-slider" oninput="updateCCT(this.value)">
        
        <div class="flex items-center gap-3 mt-3 bg-gray-900/30 p-2 rounded-lg">
            <i class="fa-solid fa-lightbulb text-gray-500 text-xs"></i>
            <input type="range" min="0" max="255" id="bri-white" class="w-full h-1 bg-gray-600 rounded cursor-pointer" onchange="updateBri('white', this.value)">
        </div>
    </div>

    <!-- RGB CARD -->
    <div id="card-rgb" class="glass-card w-full max-w-md p-4" onclick="activateType('rgb')">
        <div class="flex items-center gap-3 mb-1">
            <div class="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-300"><i class="fa-solid fa-palette"></i></div>
            <div class="flex-1">
                <h3 class="font-bold text-gray-200 text-sm">Canal Couleur</h3>
                <div class="h-1 w-full bg-gray-700 rounded-full mt-1 overflow-hidden">
                    <div id="bar-rgb" class="h-full bg-purple-500 w-0 transition-all duration-500"></div>
                </div>
            </div>
        </div>

        <div class="iro-container">
            <div id="rgb-picker"></div>
        </div>

        <div class="flex items-center gap-3 mt-3 bg-gray-900/30 p-2 rounded-lg">
            <i class="fa-solid fa-layer-group text-gray-500 text-xs"></i>
            <input type="range" min="0" max="255" id="bri-rgb" class="w-full h-1 bg-gray-600 rounded cursor-pointer" onchange="updateBri('rgb', this.value)">
        </div>
    </div>

    <!-- MASTER BUTTON -->
    <div class="fixed bottom-6 z-20">
        <button onclick="wledApi({'on':'t'})" id="master-btn" class="w-14 h-14 rounded-full bg-gray-800 border-2 border-gray-600 shadow-xl flex items-center justify-center text-gray-400 transition-all active:scale-95">
            <i class="fa-solid fa-power-off text-xl"></i>
        </button>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-4 py-2 rounded-full text-xs shadow-xl opacity-0 transition-opacity pointer-events-none z-50">
        Action effectuée
    </div>

    <script>
        // --- CONFIGURATION ---
        const TOTAL_ZONES = 60;
        let zoneState = new Array(TOTAL_ZONES).fill(false);
        let maxSegmentId = 0; // Pour savoir combien de segments on a créés

        // --- 1. ZONE MANAGER ---
        
        function initGrid() {
            const grid = document.getElementById('zone-grid');
            grid.innerHTML = '';
            for(let i=0; i<TOTAL_ZONES; i++) {
                let div = document.createElement('div');
                div.className = 'zone-block';
                if((i+1)%5===0) {
                    let lbl = document.createElement('span');
                    lbl.className = 'zone-label';
                    lbl.innerText = i+1;
                    div.appendChild(lbl);
                }
                div.onclick = () => {
                    zoneState[i] = !zoneState[i];
                    div.classList.toggle('active');
                };
                grid.appendChild(div);
            }
        }

        function zonesSelectAll(bool) {
            zoneState.fill(bool);
            const blocks = document.getElementById('zone-grid').children;
            for(let b of blocks) b.classList.toggle('active', bool);
        }

        function toggleZonePanel() {
            const content = document.getElementById('zone-content');
            const chev = document.getElementById('zone-chevron');
            content.classList.toggle('hidden');
            chev.style.transform = content.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
        }

        // --- 2. LOGIQUE SEGMENTS (Le Cerveau) ---

        async function applyZones() {
            showToast("Calcul et envoi des segments...");
            
            // 1. Trouver les groupes contigus
            let groups = [];
            let start = -1;
            for(let i=0; i<TOTAL_ZONES; i++) {
                if(zoneState[i] && start === -1) start = i;
                else if(!zoneState[i] && start !== -1) {
                    groups.push({start, stop: i});
                    start = -1;
                }
            }
            if(start !== -1) groups.push({start, stop: TOTAL_ZONES});

            // 2. Construire le JSON WLED
            // On commence par effacer tous les segments existants (reset)
            // WLED permet ça en envoyant un segment ID:0 avec stop:0, mais c'est risqué.
            // Mieux : On écrase les segments ID 0 à X.
            
            let segments = [];
            let id = 0;

            if(groups.length === 0) {
                // Tout éteindre si aucune zone
                segments.push({"id": 0, "stop": 0}); 
            } else {
                groups.forEach(g => {
                    // Création Segment RGB (Pair)
                    segments.push({
                        "id": id++,
                        "start": g.start * 2,
                        "stop": g.stop * 2,
                        "grp": 1, "spc": 1, "of": 0, "on": true,
                        "n": `Z${g.start}-RGB`
                    });
                    // Création Segment WHITE (Impair)
                    segments.push({
                        "id": id++,
                        "start": (g.start * 2) + 1,
                        "stop": (g.stop * 2) + 1,
                        "grp": 1, "spc": 1, "of": 0, "on": true,
                        "n": `Z${g.start}-W`
                    });
                });
            }
            
            maxSegmentId = id; // On retient combien on en a (ex: 4 segments pour 2 zones)

            // Envoi API
            await wledApi({ "seg": segments });
            
            // On force une couleur par défaut pour vérifier que ça marche
            // wledApi({ "seg": [{"id":0, "on":true}, {"id":1, "on":true}] }); 
            
            showToast("Configuration appliquée !");
        }


        // --- 3. LOGIQUE DE CONTROLE (Fusion/Exclusion) ---

        function isFusion() { return document.getElementById('fusion-toggle').checked; }

        // Génère la liste des segments à modifier
        // type = 'rgb' (Pairs: 0, 2...) ou 'white' (Impairs: 1, 3...)
        function getTargetSegments(type, forceOn = false) {
            let targets = [];
            
            // On parcourt tous les segments connus (maxSegmentId)
            // Si on ne connait pas maxSegmentId (reload page), on assume jusqu'à 16 par sécurité
            const limit = (maxSegmentId > 0) ? maxSegmentId : 16; 

            for(let i=0; i < limit; i++) {
                // Logique RGB vs White
                const isWhiteSeg = (i % 2 !== 0); // 1, 3, 5 = White
                const isRgbSeg = (i % 2 === 0);   // 0, 2, 4 = RGB
                
                // CIBLE PRINCIPALE (celle qu'on veut contrôler)
                if ( (type === 'white' && isWhiteSeg) || (type === 'rgb' && isRgbSeg) ) {
                    let segObj = { "id": i };
                    if(forceOn) segObj.on = true;
                    targets.push(segObj);
                }
                
                // CIBLE SECONDAIRE (celle qu'on doit peut-être éteindre)
                else if (!isFusion()) {
                    // Mode Exclusif : On éteint l'autre type
                    targets.push({ "id": i, "on": false });
                }
            }
            return targets;
        }

        function activateType(type) {
            updateVisuals(type);
            // On allume juste les segments concernés sans changer la couleur
            const segs = getTargetSegments(type, true);
            wledApi({ "seg": segs });
        }

        // --- CCT ---
        let cctTimer;
        function updateCCT(val) {
            let r, g, b=0;
            const p = parseInt(val);
            if(p <= 50) { r=255; g=Math.floor((p/50)*255); }
            else { g=255; r=Math.floor(255-((p-50)/50)*255); }

            // Récupère les segments blancs (+ éteint les RGB si exclusif)
            let segs = getTargetSegments('white', true);
            
            // Ajoute la couleur aux segments blancs
            segs.forEach(s => {
                if(s.on !== false) s.col = [[r,g,b]];
            });

            clearTimeout(cctTimer);
            cctTimer = setTimeout(() => wledApi({"seg": segs}), 50);
        }

        function updateBri(type, val) {
            let segs = getTargetSegments(type, false); // false = ne force pas ON, change juste bri
            segs.forEach(s => {
                 // On applique la bri seulement si on ne l'éteint pas
                 if(s.on !== false) s.bri = parseInt(val);
            });
            wledApi({"seg": segs});
        }

        // --- RGB ---
        var rgbPicker = new iro.ColorPicker("#rgb-picker", {
            width: 220, layout: [{ component: iro.ui.Wheel, options: { wheelLightness: false } }],
            color: "#8b5cf6"
        });

        rgbPicker.on('input:end', (c) => {
            const {r,g,b} = c.rgb;
            let segs = getTargetSegments('rgb', true);
            segs.forEach(s => {
                if(s.on !== false) s.col = [[r,g,b]];
            });
            wledApi({"seg": segs});
        });


        // --- UI & SYSTEM ---

        function updateVisuals(activeType) {
            const cardW = document.getElementById('card-white');
            const cardR = document.getElementById('card-rgb');
            const barW = document.getElementById('bar-white');
            const barR = document.getElementById('bar-rgb');

            if(isFusion()) {
                cardW.className = "glass-card w-full max-w-md p-4 active-mode";
                cardR.className = "glass-card w-full max-w-md p-4 active-mode";
                barW.style.width = "100%"; barR.style.width = "100%";
                return;
            }

            if(activeType === 'white') {
                cardW.className = "glass-card w-full max-w-md p-4 active-mode";
                cardR.className = "glass-card w-full max-w-md p-4 inactive-mode";
                barW.style.width = "100%"; barR.style.width = "0%";
            } else {
                cardW.className = "glass-card w-full max-w-md p-4 inactive-mode";
                cardR.className = "glass-card w-full max-w-md p-4 active-mode";
                barW.style.width = "0%"; barR.style.width = "100%";
            }
        }

        async function wledApi(data) {
            const ip = document.getElementById('wled-ip').value;
            if(!ip) return;
            try {
                const res = await fetch(`http://${ip}/json/state`, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify(data)
                });
                const json = await res.json();
                
                // Feedback Master
                const btn = document.getElementById('master-btn');
                if(json.on) {
                    btn.classList.add('border-green-500', 'text-green-500');
                    btn.classList.remove('border-gray-600', 'text-gray-400');
                } else {
                    btn.classList.remove('border-green-500', 'text-green-500');
                    btn.classList.add('border-gray-600', 'text-gray-400');
                }
            } catch(e) { console.error(e); }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = 1;
            setTimeout(()=>t.style.opacity=0, 2000);
        }

        // INIT
        initGrid();
        const savedIp = localStorage.getItem('wled_ip');
        if(savedIp) {
            document.getElementById('wled-ip').value = savedIp;
            wledApi({}); // Check status
        }
        document.getElementById('wled-ip').addEventListener('input', (e) => localStorage.setItem('wled_ip', e.target.value));

    </script>
</body>
</html>

