<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WLED Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        body { background-color: #1a1a1a; color: #e0e0e0; font-family: 'Segoe UI', system-ui, sans-serif; }
        .slider-thumb::-webkit-slider-thumb { appearance: none; width: 20px; height: 20px; background: #3b82f6; border-radius: 50%; cursor: pointer; }
        .glass-panel { background: rgba(40, 40, 40, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .btn-preset { transition: all 0.2s; }
        .btn-preset:active { transform: scale(0.95); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Main Controller Container -->
    <div class="glass-panel w-full max-w-md rounded-2xl shadow-2xl overflow-hidden p-6 space-y-6">
        
        <!-- Header & Connection Status -->
        <div class="flex justify-between items-center border-b border-gray-700 pb-4">
            <div>
                <h1 class="text-2xl font-bold text-white tracking-tight">Salon <span class="text-blue-500">Light</span></h1>
                <p class="text-xs text-gray-400">Contrôle Hybride RGB + White</p>
            </div>
            <div id="status-indicator" class="w-3 h-3 rounded-full bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)]"></div>
        </div>

        <!-- Master Controls -->
        <div class="space-y-4">
            <div class="flex justify-between items-center">
                <span class="font-medium text-gray-300">Alimentation Maître</span>
                <button onclick="togglePower()" id="power-btn" class="w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center text-xl hover:bg-gray-600 transition shadow-lg">
                    <i class="fa-solid fa-power-off"></i>
                </button>
            </div>

            <div>
                <label class="text-xs text-gray-400 uppercase font-bold tracking-wider">Luminosité Globale</label>
                <input type="range" min="0" max="255" id="master-bri" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer mt-2" onchange="setBrightness(this.value)">
            </div>
        </div>

        <!-- Dual Channel Control -->
        <div class="grid grid-cols-2 gap-4">
            <!-- Channel RGB -->
            <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-bold text-blue-400"><i class="fa-solid fa-palette mr-2"></i>RGB</span>
                    <input type="color" id="color-picker" class="w-8 h-8 rounded cursor-pointer bg-transparent border-0" onchange="setSegmentColor(0, this.value)">
                </div>
                <label class="text-xs text-gray-500">Intensité Segment 0</label>
                <input type="range" min="0" max="255" class="w-full h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer mt-2" onchange="setSegmentBrightness(0, this.value)">
            </div>

            <!-- Channel White -->
            <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-bold text-yellow-200"><i class="fa-regular fa-sun mr-2"></i>Blanc</span>
                    <!-- White toggle/indicator -->
                    <div class="w-3 h-3 bg-yellow-100 rounded-full shadow-[0_0_10px_yellow]"></div>
                </div>
                <label class="text-xs text-gray-500">Intensité Segment 1</label>
                <input type="range" min="0" max="255" class="w-full h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer mt-2" onchange="setSegmentBrightness(1, this.value)">
            </div>
        </div>

        <!-- Quick Presets -->
        <div>
            <label class="text-xs text-gray-400 uppercase font-bold tracking-wider mb-3 block">Scènes Rapides</label>
            <div class="grid grid-cols-3 gap-3">
                <button onclick="loadPreset(1)" class="btn-preset bg-gradient-to-br from-indigo-600 to-blue-700 py-3 rounded-lg text-sm font-medium shadow-lg text-white">
                    <i class="fa-solid fa-tv block mb-1"></i> TV
                </button>
                <button onclick="loadPreset(2)" class="btn-preset bg-gradient-to-br from-orange-500 to-yellow-600 py-3 rounded-lg text-sm font-medium shadow-lg text-white">
                    <i class="fa-solid fa-book-open block mb-1"></i> Lecture
                </button>
                <button onclick="loadPreset(3)" class="btn-preset bg-gradient-to-br from-pink-600 to-purple-700 py-3 rounded-lg text-sm font-medium shadow-lg text-white">
                    <i class="fa-solid fa-glass-martini-alt block mb-1"></i> Soirée
                </button>
            </div>
            <div class="grid grid-cols-2 gap-3 mt-3">
                 <button onclick="setSegmentBrightness(1, 255); setSegmentBrightness(0, 0);" class="btn-preset bg-gray-700 py-2 rounded-lg text-xs font-bold border border-gray-600">
                    FULL WHITE
                </button>
                <button onclick="setSegmentBrightness(1, 0); setSegmentBrightness(0, 255);" class="btn-preset bg-gray-700 py-2 rounded-lg text-xs font-bold border border-gray-600">
                    FULL RGB
                </button>
            </div>
        </div>

        <!-- Technical Footer -->
        <div class="text-center pt-2">
            <p class="text-[10px] text-gray-600">API Latency: <span id="latency">--</span>ms • WLED v0.14.4</p>
            <input type="text" id="ip-address" value="192.168.1.50" class="mt-2 bg-transparent text-center text-gray-600 text-xs border-b border-gray-700 focus:outline-none focus:border-blue-500" placeholder="IP WLED">
        </div>

    </div>

    <script>
        // CONFIGURATION
        // Remplacer par l'IP de votre ESP32 si statique, ou utiliser le champ input
        let wledIp = document.getElementById('ip-address').value;

        // Fonction utilitaire pour appeler l'API JSON
        async function wledApi(data) {
            wledIp = document.getElementById('ip-address').value;
            const start = Date.now();
            try {
                const response = await fetch(`http://${wledIp}/json/state`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const json = await response.json();
                updateUI(json);
                
                // Calcul latence
                const latency = Date.now() - start;
                document.getElementById('latency').innerText = latency;
                document.getElementById('status-indicator').className = "w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]";
                
                return json;
            } catch (error) {
                console.error("Erreur WLED:", error);
                document.getElementById('status-indicator').className = "w-3 h-3 rounded-full bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)]";
            }
        }

        // Mettre à jour l'UI avec l'état actuel
        function updateUI(state) {
            // Master ON/OFF
            const pwrBtn = document.getElementById('power-btn');
            if(state.on) {
                pwrBtn.classList.add('text-green-400', 'bg-gray-700');
                pwrBtn.classList.remove('text-gray-400');
            } else {
                pwrBtn.classList.remove('text-green-400', 'bg-gray-700');
                pwrBtn.classList.add('text-gray-400');
            }
            
            // Master Brightness
            document.getElementById('master-bri').value = state.bri;

            // Segment Specifics (si dispos)
            if(state.seg && state.seg.length > 1) {
                // Supposons Seg 0 = RGB, Seg 1 = White (Brightness only)
                // Note: WLED retourne 'bri' par segment s'il est setté
            }
        }

        // COMMANDES
        function togglePower() {
            wledApi({ "on": "t" });
        }

        function setBrightness(val) {
            wledApi({ "bri": parseInt(val) });
        }

        function setSegmentBrightness(segId, val) {
            // Pour cibler un segment spécifique en JSON API
            wledApi({ 
                "seg": [
                    { "id": segId, "bri": parseInt(val), "on": true } 
                ]
            });
        }

        function setSegmentColor(segId, hex) {
            // Conversion Hex à RGB
            const r = parseInt(hex.substr(1,2), 16);
            const g = parseInt(hex.substr(3,2), 16);
            const b = parseInt(hex.substr(5,2), 16);

            wledApi({ 
                "seg": [
                    { "id": segId, "col": [[r, g, b]], "on": true }
                ]
            });
        }

        function loadPreset(id) {
            wledApi({ "ps": id });
        }

        // Initial fetch
        setInterval(() => {
             // Polling léger pour garder l'état synchro (optionnel)
             // wledApi({}); 
        }, 5000);
    </script>
</body>
</html>
