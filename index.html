<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WLED Commander FX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: 'Segoe UI', system-ui, sans-serif; overscroll-behavior: none; user-select: none; padding-bottom: 100px; }
        
        /* Grille Zones */
        .zone-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 2px; margin-bottom: 10px; }
        .zone-block { aspect-ratio: 1; background-color: #334155; border-radius: 2px; cursor: pointer; position: relative; }
        .zone-block.active { background-color: #3b82f6; box-shadow: 0 0 5px rgba(59, 130, 246, 0.5); border: 1px solid #93c5fd; }
        .zone-label { position: absolute; bottom: 0px; right: 1px; font-size: 5px; color: rgba(255,255,255,0.4); }
        
        /* Cartes */
        .glass-card { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 20px; transition: all 0.3s ease; }
        .glass-card.inactive-mode { opacity: 0.5; filter: grayscale(0.8); border: 1px solid transparent; }
        .glass-card.active-mode { border-color: rgba(59, 130, 246, 0.6); background: rgba(30, 41, 59, 0.95); box-shadow: 0 0 15px rgba(59, 130, 246, 0.1); }
        
        /* Sliders */
        input[type=range].cct-slider { -webkit-appearance: none; width: 100%; height: 24px; border-radius: 12px; background: linear-gradient(to right, #ff8c00 0%, #ffebcd 45%, #ffffff 50%, #e0ffff 55%, #a0c4ff 100%); outline: none; margin-top: 5px; }
        input[type=range].cct-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 30px; height: 30px; border-radius: 50%; background: #fff; border: 3px solid #1e293b; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        input[type=range].std-slider { -webkit-appearance: none; width: 100%; height: 6px; border-radius: 3px; background: #475569; outline: none; }
        input[type=range].std-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #fff; cursor: pointer; }

        .toggle-checkbox:checked { right: 0; border-color: #3b82f6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }
        .iro-container { display: flex; justify-content: center; margin-top: 5px; }
        
        /* Liste Effets */
        .fx-btn { text-align: left; padding: 8px 12px; font-size: 0.75rem; border-radius: 6px; background: rgba(255,255,255,0.05); margin-bottom: 4px; transition: 0.2s; border: 1px solid transparent; }
        .fx-btn:hover { background: rgba(255,255,255,0.1); }
        .fx-btn.selected { background: #2563eb; color: white; border-color: #60a5fa; font-weight: bold; }
    </style>
</head>
<body class="min-h-screen p-3 flex flex-col items-center gap-4">

    <!-- HEADER -->
    <div class="w-full max-w-md space-y-3">
        <div class="flex justify-between items-center">
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-300">
                WLED <span class="text-gray-500 font-light">FX</span>
            </h1>
            <div class="flex items-center gap-2">
                <input type="text" id="wled-ip" class="bg-gray-800/50 rounded px-2 py-1 text-xs text-gray-400 w-28 text-center focus:outline-none focus:text-white transition-all border border-transparent hover:border-gray-600" placeholder="IP WLED">
            </div>
        </div>

        <div class="flex items-center justify-between bg-gray-800/50 rounded-xl p-2 px-3 border border-white/5">
            <span class="text-xs text-gray-300 flex items-center gap-2"><i class="fa-solid fa-link"></i> Mode Combiné</span>
            <div class="relative inline-block w-8 align-middle select-none">
                <input type="checkbox" id="fusion-toggle" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 ease-in-out left-0 top-0"/>
                <label for="fusion-toggle" class="toggle-label block overflow-hidden h-4 rounded-full bg-gray-700 cursor-pointer"></label>
            </div>
        </div>
    </div>

    <!-- ZONE SELECTOR -->
    <div class="glass-card w-full max-w-md p-4">
        <div class="flex justify-between items-center mb-2 cursor-pointer" onclick="toggleZonePanel()">
            <h2 class="text-xs font-bold uppercase text-gray-400 tracking-wider"><i class="fa-solid fa-ruler-horizontal mr-1"></i>Zones (97)</h2>
            <i class="fa-solid fa-chevron-down text-gray-500 text-xs transition-transform" id="zone-chevron"></i>
        </div>
        <div id="zone-content" class="hidden">
            <div class="flex justify-end gap-2 mb-2 text-[10px]">
                <button onclick="zonesSelectAll(true)" class="text-blue-400">Tout</button>
                <button onclick="zonesSelectAll(false)" class="text-gray-400">Rien</button>
            </div>
            <div class="max-h-60 overflow-y-auto pr-1">
                <div id="zone-grid" class="zone-grid"></div>
            </div>
            <button onclick="applyZones()" class="w-full mt-2 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold py-3 rounded shadow-lg transition-colors border border-blue-400/30">
                <i class="fa-solid fa-rotate-right mr-1"></i> APPLIQUER & NETTOYER
            </button>
        </div>
    </div>

    <!-- 1. CARD WHITE -->
    <div id="card-white" class="glass-card w-full max-w-md p-4" onclick="activateType('white')">
        <div class="flex items-center gap-3 mb-3">
            <div class="w-8 h-8 rounded-full bg-orange-500/20 flex items-center justify-center text-orange-200"><i class="fa-regular fa-sun"></i></div>
            <div class="flex-1">
                <h3 class="font-bold text-gray-200 text-sm">Blanc</h3>
                <div class="h-1 w-full bg-gray-700 rounded-full mt-1 overflow-hidden"><div id="bar-white" class="h-full bg-orange-400 w-0 transition-all duration-500"></div></div>
            </div>
        </div>
        <div class="flex justify-between text-[9px] text-gray-400 uppercase tracking-widest px-1"><span>Chaud</span><span>Froid</span></div>
        <input type="range" min="0" max="100" value="50" class="cct-slider" oninput="updateCCT(this.value)">
        <div class="flex items-center gap-3 mt-3 bg-gray-900/30 p-2 rounded-lg">
            <i class="fa-solid fa-lightbulb text-gray-500 text-xs"></i>
            <input type="range" min="0" max="255" id="bri-white" class="std-slider" onchange="updateBri('white', this.value)">
        </div>
    </div>

    <!-- 2. CARD RGB -->
    <div id="card-rgb" class="glass-card w-full max-w-md p-4" onclick="activateType('rgb')">
        <div class="flex items-center gap-3 mb-1">
            <div class="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-300"><i class="fa-solid fa-palette"></i></div>
            <div class="flex-1">
                <h3 class="font-bold text-gray-200 text-sm">Couleur</h3>
                <div class="h-1 w-full bg-gray-700 rounded-full mt-1 overflow-hidden"><div id="bar-rgb" class="h-full bg-purple-500 w-0 transition-all duration-500"></div></div>
            </div>
        </div>
        <div class="iro-container"><div id="rgb-picker"></div></div>
        <div class="flex items-center gap-3 mt-3 bg-gray-900/30 p-2 rounded-lg">
            <i class="fa-solid fa-layer-group text-gray-500 text-xs"></i>
            <input type="range" min="0" max="255" id="bri-rgb" class="std-slider" onchange="updateBri('rgb', this.value)">
        </div>
    </div>

    <!-- 3. CARD EFFECTS -->
    <div id="card-fx" class="glass-card w-full max-w-md p-4" onclick="activateType('fx')">
        <div class="flex items-center gap-3 mb-3">
            <div class="w-8 h-8 rounded-full bg-pink-500/20 flex items-center justify-center text-pink-300"><i class="fa-solid fa-wand-magic-sparkles"></i></div>
            <div class="flex-1">
                <h3 class="font-bold text-gray-200 text-sm">Effets & Animations</h3>
                <p class="text-[10px] text-gray-500">S'applique aux zones Couleur</p>
            </div>
        </div>
        
        <!-- Search -->
        <div class="relative mb-3">
            <i class="fa-solid fa-search absolute left-3 top-2 text-gray-500 text-xs"></i>
            <input type="text" id="fx-search" placeholder="Rechercher un effet..." class="w-full bg-gray-800/50 border border-gray-600 rounded-lg py-1 pl-8 pr-2 text-xs text-white focus:border-blue-500 outline-none" onkeyup="filterEffects(this.value)">
        </div>

        <!-- List Container -->
        <div id="fx-list" class="h-40 overflow-y-auto pr-1 mb-4 custom-scroll flex flex-col gap-1">
            <div class="text-center text-xs text-gray-500 py-4">Saisissez l'IP WLED pour charger les effets</div>
        </div>

        <!-- Speed & Intensity -->
        <div class="grid grid-cols-2 gap-3">
            <div class="bg-gray-900/30 p-2 rounded-lg">
                <label class="text-[9px] text-gray-400 uppercase font-bold">Vitesse</label>
                <input type="range" min="0" max="255" value="128" class="std-slider w-full mt-1" onchange="updateFXParam('sx', this.value)">
            </div>
            <div class="bg-gray-900/30 p-2 rounded-lg">
                <label class="text-[9px] text-gray-400 uppercase font-bold">Intensité</label>
                <input type="range" min="0" max="255" value="128" class="std-slider w-full mt-1" onchange="updateFXParam('ix', this.value)">
            </div>
        </div>
    </div>

    <!-- MASTER BUTTON -->
    <div class="fixed bottom-6 z-20">
        <button onclick="wledApi({'on':'t'})" id="master-btn" class="w-14 h-14 rounded-full bg-gray-800 border-2 border-gray-600 shadow-xl flex items-center justify-center text-gray-400 transition-all active:scale-95"><i class="fa-solid fa-power-off text-xl"></i></button>
    </div>

    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-4 py-2 rounded-full text-xs shadow-xl opacity-0 transition-opacity pointer-events-none z-50">Action effectuée</div>

    <script>
        // ==========================================
        // VERSION AUTONOME (SANS TOKEN HA)
        // ==========================================
        const TOTAL_ZONES = 97;
        const MAX_WLED_SEGMENTS = 32;
        let zoneState = new Array(TOTAL_ZONES).fill(false);
        let activeSegmentCount = 0;
        let currentWledIP = localStorage.getItem('wled_ip') || ""; 
        let allEffects = []; 

        // --- 0. INIT ---
        function initApp() {
            initGrid();
            const ipInput = document.getElementById('wled-ip');
            
            // Charger IP si dispo
            if(currentWledIP) {
                ipInput.value = currentWledIP;
                wledApi({}); 
                fetchEffectsList(); 
            }

            // Sauvegarde IP à chaque saisie
            ipInput.addEventListener('input', (e) => {
                currentWledIP = e.target.value;
                localStorage.setItem('wled_ip', currentWledIP);
            });

            // Recharger effets si on quitte le champ IP
            ipInput.addEventListener('change', () => fetchEffectsList());
        }

        // --- 1. FX MANAGER ---
        async function fetchEffectsList() {
            if(!currentWledIP) return;
            const container = document.getElementById('fx-list');
            try {
                container.innerHTML = '<div class="text-center text-xs text-gray-500 py-4">Chargement...</div>';
                const res = await fetch(`http://${currentWledIP}/json/effects`);
                allEffects = await res.json();
                renderEffectsList(allEffects);
            } catch(e) {
                container.innerHTML = '<div class="text-red-400 text-xs text-center">Erreur chargement effets (IP incorrecte ?)</div>';
            }
        }

        function renderEffectsList(list) {
            const container = document.getElementById('fx-list');
            container.innerHTML = '';
            list.forEach((fxName, index) => {
                const btn = document.createElement('button');
                btn.className = 'fx-btn w-full';
                btn.innerText = fxName;
                btn.onclick = () => setEffect(index, btn);
                container.appendChild(btn);
            });
        }

        function filterEffects(query) {
            const container = document.getElementById('fx-list');
            const btns = container.getElementsByTagName('button');
            const term = query.toLowerCase();
            for(let btn of btns) {
                if(btn.innerText.toLowerCase().includes(term)) btn.style.display = "block";
                else btn.style.display = "none";
            }
        }

        function setEffect(id, btnElement) {
            const allBtns = document.getElementById('fx-list').getElementsByTagName('button');
            for(let b of allBtns) b.classList.remove('selected');
            if(btnElement) btnElement.classList.add('selected');

            activateType('fx'); 
            const segs = getTargetSegments('rgb', true);
            segs.forEach(s => { if(s.on !== false) s.fx = id; });
            wledApi({ "seg": segs });
        }

        function updateFXParam(param, val) {
            const segs = getTargetSegments('rgb', true); 
            segs.forEach(s => { if(s.on !== false) s[param] = parseInt(val); });
            wledApi({ "seg": segs });
        }


        // --- 2. ZONE MANAGER ---
        function initGrid() {
            const grid = document.getElementById('zone-grid'); grid.innerHTML = '';
            for(let i=0; i<TOTAL_ZONES; i++) {
                let div = document.createElement('div'); div.className = 'zone-block';
                if((i+1)%10===0) { let lbl = document.createElement('span'); lbl.className = 'zone-label'; lbl.innerText = i+1; div.appendChild(lbl); }
                div.onclick = () => { zoneState[i] = !zoneState[i]; div.classList.toggle('active'); };
                grid.appendChild(div);
            }
        }
        function zonesSelectAll(bool) { zoneState.fill(bool); const blocks = document.getElementById('zone-grid').children; for(let b of blocks) b.classList.toggle('active', bool); }
        function toggleZonePanel() { const c = document.getElementById('zone-content'); const v = document.getElementById('zone-chevron'); c.classList.toggle('hidden'); v.style.transform = c.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)'; }

        async function applyZones() {
            showToast("Application...");
            let groups = [], start = -1;
            for(let i=0; i<TOTAL_ZONES; i++) { if(zoneState[i] && start === -1) start = i; else if(!zoneState[i] && start !== -1) { groups.push({start, stop: i}); start = -1; } }
            if(start !== -1) groups.push({start, stop: TOTAL_ZONES});

            let payload = [], id = 0;
            if(groups.length > 0) {
                groups.forEach(g => {
                    if(id >= MAX_WLED_SEGMENTS - 2) return;
                    payload.push({ "id": id++, "start": g.start*2, "stop": g.stop*2, "grp": 1, "spc": 1, "of": 0, "on": true, "n": `Z${g.start}-RGB` });
                    payload.push({ "id": id++, "start": (g.start*2)+1, "stop": (g.stop*2)+1, "grp": 1, "spc": 1, "of": 0, "on": true, "n": `Z${g.start}-W` });
                });
            } else { payload.push({"id": 0, "stop": 0, "on": false}); id = 1; }
            for (let i = id; i < MAX_WLED_SEGMENTS; i++) payload.push({ "id": i, "stop": 0, "on": false });
            activeSegmentCount = id;
            await wledApi({ "seg": payload }); showToast("Zones Configuré !");
        }

        // --- 3. LOGIC CONTROLS ---
        function isFusion() { return document.getElementById('fusion-toggle').checked; }
        
        function getTargetSegments(type, forceOn = false) {
            let targets = []; const limit = (activeSegmentCount > 0) ? activeSegmentCount : 16;
            for(let i=0; i < limit; i++) {
                const isWhite = (i % 2 !== 0), isRgb = (i % 2 === 0);
                const targetMatch = (type === 'white' && isWhite) || ((type === 'rgb' || type === 'fx') && isRgb);
                
                if (targetMatch) { 
                    let s = { "id": i }; 
                    if(forceOn) s.on = true; 
                    targets.push(s); 
                }
                else if (!isFusion()) {
                    const isSameGroup = (type === 'rgb' && isRgb) || (type === 'fx' && isRgb);
                    if(!isSameGroup) targets.push({ "id": i, "on": false });
                }
            }
            return targets;
        }

        function activateType(type) { 
            updateVisuals(type); 
            if(type !== 'fx') {
                const s = getTargetSegments(type, true); 
                wledApi({ "seg": s }); 
            }
        }
        
        let cctTimer;
        function updateCCT(val) {
            let r, g, b=0; const p = parseInt(val);
            if(p <= 50) { g=255; r=Math.floor((p/50)*255); } else { r=255; g=Math.floor(255-((p-50)/50)*255); }
            let s = getTargetSegments('white', true); s.forEach(seg => { if(seg.on !== false) seg.col = [[r,g,b]]; });
            clearTimeout(cctTimer); cctTimer = setTimeout(() => wledApi({"seg": s}), 50);
        }

        function updateBri(type, val) { let s = getTargetSegments(type, false); s.forEach(seg => { if(seg.on !== false) seg.bri = parseInt(val); }); wledApi({"seg": s}); }

        var rgbPicker = new iro.ColorPicker("#rgb-picker", { width: 220, layout: [{ component: iro.ui.Wheel, options: { wheelLightness: false } }], color: "#8b5cf6" });
        rgbPicker.on('input:end', (c) => { 
            const {r,g,b} = c.rgb; 
            let s = getTargetSegments('rgb', true); 
            s.forEach(seg => { 
                if(seg.on !== false) {
                    seg.col = [[r,g,b]]; 
                    seg.fx = 0; 
                }
            }); 
            wledApi({"seg": s}); 
        });

        function updateVisuals(type) {
            const cW = document.getElementById('card-white');
            const cR = document.getElementById('card-rgb');
            const cF = document.getElementById('card-fx');
            
            cW.className = cR.className = cF.className = "glass-card w-full max-w-md p-4 inactive-mode";
            document.getElementById('bar-white').style.width = "0%";
            document.getElementById('bar-rgb').style.width = "0%";

            if(isFusion()) {
                cW.className = cR.className = cF.className = "glass-card w-full max-w-md p-4 active-mode";
                document.getElementById('bar-white').style.width = "100%";
                document.getElementById('bar-rgb').style.width = "100%";
                return;
            }

            if(type === 'white') {
                cW.className="glass-card w-full max-w-md p-4 active-mode";
                document.getElementById('bar-white').style.width = "100%";
            } else if(type === 'rgb') {
                cR.className="glass-card w-full max-w-md p-4 active-mode";
                document.getElementById('bar-rgb').style.width = "100%";
            } else if(type === 'fx') {
                cF.className="glass-card w-full max-w-md p-4 active-mode";
                cR.className="glass-card w-full max-w-md p-4"; 
                cR.style.opacity = "0.8";
                document.getElementById('bar-rgb').style.width = "100%";
            }
        }

        async function wledApi(data) {
            if(!currentWledIP) return;
            try {
                const res = await fetch(`http://${currentWledIP}/json/state`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
                const json = await res.json();
                const btn = document.getElementById('master-btn');
                if(json.on) { btn.classList.add('border-green-500', 'text-green-500'); btn.classList.remove('border-gray-600', 'text-gray-400'); }
                else { btn.classList.remove('border-green-500', 'text-green-500'); btn.classList.add('border-gray-600', 'text-gray-400'); }
            } catch(e) { console.error(e); }
        }
        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.style.opacity = 1; setTimeout(()=>t.style.opacity=0, 2000); }

        initApp();
    </script>
</body>
</html>
